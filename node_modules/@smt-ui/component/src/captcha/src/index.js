/**
 * @file captcha
 * @author v_zhaoxinggang
 * @date 2020-08-17
 */

import {isIos} from './../../common/utils/index';

/* global swan */

Component({ // eslint-disable-line
    externalClasses: [
        'smt-label',
        'smt-code'
    ],

    properties: {

        // label宽度 默认四字
        labelWidth: {
            type: String,
            value: '4em'
        },

        // 定义 input name 属性，一般作为表单提交的 key
        inputName: {
            type: String,
            value: 'code'
        },

        // 输入框左侧文案
        label: {
            type: String,
            value: '验证码'
        },

        // 输入框占位文案
        placeholder: {
            type: String,
            value: '请输入验证码'
        },

        // 输入框占位文案颜色
        placeholderColor: {
            type: String,
            value: '#ccc'
        },

        // 输入框 value
        value: {
            type: String,
            value: '',
            observer(val) {
                val && this.setData('value', val);
            }
        },

        // input类型：text、number、idcard、digit
        type: {
            type: String,
            value: 'text'
        },

        // 输入最大长度
        maxlength: {
            type: Number,
            value: 4
        },

        // 获取聚焦，调起键盘
        focus: {
            type: Boolean,
            value: false
        },

        // 详细配置见基础组件 input
        confirmType: {
            type: String,
            value: 'done'
        },

        // 图片验证码的 url 地址
        verifyImgUrl: {
            type: String,
            value: '',
            observer(val) {
                val && this.setVerifyImgUrl(val);
            }
        },

        // 错误提示信息，有值时左侧label会漂红
        inputErrMsg: {
            type: String,
            value: ''
        },

        // 是否有下边线
        border: {
            type: Boolean,
            value: true
        }
    },

    data: {

        // 是否 ios
        isIos,

        // 验证码状态 loading 加载中、loaded 加载完成、reload 重新加载，此状态可点击再次触发获取验证码事件
        codeStatus: 'loaded',

        // 验证码图片地址
        verifyImgUrlData: ''
    },

    methods: {

        /**
         * 验证码图片链接加载失败时，默认显示重新加载按钮，点击重新加载再次触发获取验证码事件
         */
        imgErr(e) {
            this.setData({
                codeStatus: 'reload',
                verifyImgUrlData: ''
            });
        },

        // 图片加载成功，修改状态为加载完成 loaded
        imgLoaded(e) {
            this.setData('codeStatus', 'loaded');
        },

        /**
         * 子组件事件触发时触发父组件自定义事件
         *
         * @param {string} detail.value input 的 value
         * @param {string} type input 触发事件类型
         */
        trigger({detail, type}) {
            const {inputName, maxlength} = this.data;

            // 解决安卓三星机型 input maxlength 失效问题
            this.setData('value', detail.value.slice(0, this.maxlength));
            const iptParams = {
                iptName: inputName,
                iptValue: detail.value,
                check: detail.value.length === maxlength
            };
            this.triggerEvent(type, iptParams);
        },

        /**
         * 点击验证码或重新加载按钮时触发
         */
        refreshImg() {
            if (this.data.codeStatus !== 'loading') {
                this.setData({
                    codeStatus: 'loading',
                    verifyImgUrlData: ''
                });
                this.triggerEvent('refreshimg', {
                    reload: () => {
                        this.setData('codeStatus', 'reload');
                    }
                });
            }
        },

        /**
         * 更新验证码
         */
        setVerifyImgUrl() {
            this.setData({
                verifyImgUrlData: this.data.verifyImgUrl,
                codeStatus: 'loaded'
            });
        }
    }
});
